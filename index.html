<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Contas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --cor-fundo: #1a4331; --cor-superficie: #ffffff; --cor-superficie-secundaria: #f0f2f5;
            --cor-borda: #e0e6ed; --cor-texto-principal: #172b4d; --cor-texto-secundario: #5e6c84;
            --cor-texto-inverso: #ffffff; --cor-perigo: #e53935; --cor-sucesso: #00875a;
            --cor-sucesso-fundo: #e3fcef; --cor-aviso: #ffab00; --fonte-principal: 'Inter', sans-serif;
            --sombra-suave: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--fonte-principal); background-color: var(--cor-fundo); color: var(--cor-texto-inverso); padding: 25px; }
        h1, h2 { text-align: center; margin-bottom: 25px; font-weight: 600; }
        h3 { color: var(--cor-texto-principal); margin-bottom: 15px; font-weight: 600; }
        
        /* --- CABE√áALHO DO APP --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: relative; }
        .header-actions-left, .header-actions-right { display: flex; align-items: center; gap: 10px; }
        .user-info { font-weight: 500; font-size: 14px; }

        /* --- TELA DE LOGIN --- */
        #auth-view { max-width: 400px; margin: 100px auto; padding: 40px; background-color: var(--cor-superficie); border-radius: 12px; color: var(--cor-texto-principal); box-shadow: var(--sombra-suave); }
        .auth-form-container .input-group { margin-bottom: 15px; }
        .auth-form-container input { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid var(--cor-borda); font-size: 16px; }
        .auth-actions { display: flex; flex-direction: column; gap: 10px; }
        .auth-actions .btn { width: 100%; font-size: 16px; padding: 12px; }
        #auth-error-message { color: var(--cor-perigo); margin-top: 15px; text-align: center; font-weight: 500; min-height: 20px; }
        
        .dashboard { display: grid; grid-template-columns: 1.5fr 1fr; grid-template-rows: auto auto 1fr; gap: 20px; max-width: 1400px; margin: auto; grid-template-areas: "header-main header-side" "form-conta  resumo-side" "contas-main resumo-side"; }
        .panel { background-color: var(--cor-superficie); color: var(--cor-texto-principal); border-radius: 12px; padding: 25px; box-shadow: var(--sombra-suave); }
        #header-main { grid-area: header-main; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; }
        #header-side { grid-area: header-side; background-color: var(--cor-superficie-secundaria); padding: 15px; }
        #form-conta { grid-area: form-conta; } #contas-main { grid-area: contas-main; }
        #resumo-side { grid-area: resumo-side; display: flex; flex-direction: column; gap: 20px; }
        .total-mes-item { font-size: 1.1em; text-align: center; width: 100%; }
        .total-mes-item span { display: block; font-size: 0.8em; color: var(--cor-texto-secundario); margin-bottom: 5px; }
        #total-a-pagar, #total-pago, #total-geral { font-weight: 700; font-size: 1.5em; }
        #total-a-pagar { color: var(--cor-perigo); } #total-pago { color: var(--cor-sucesso); } #total-geral { color: var(--cor-texto-principal); }
        .calendar { text-align: center; } .calendar-header { font-size: 1.5em; font-weight: 700; margin-bottom: 15px; }
        .calendar-table { width: 100%; border-collapse: collapse; }
        .calendar-table th, .calendar-table td { text-align: center; padding: 2px; }
        .calendar-table th { font-size: 0.8em; color: var(--cor-texto-secundario); padding-bottom: 10px; }
        .day-cell { width: 32px; height: 32px; line-height: 32px; margin: auto; display: flex; justify-content: center; align-items: center; border-radius: 50%; }
        .today { background-color: var(--cor-sucesso); color: white; font-weight: 700; }
        .resumo-categoria-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: var(--cor-superficie-secundaria); border-radius: 6px; margin-bottom: 8px; font-weight: 500; }
        .month-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .month-btn { background-color: var(--cor-superficie-secundaria); border: 1px solid var(--cor-borda); border-radius: 6px; padding: 10px; cursor: pointer; text-align: left; transition: background-color 0.2s, color 0.2s; font-weight: 600; }
        .month-btn:hover { background-color: #d1d9e2; }
        .month-btn.active { background-color: var(--cor-sucesso); color: white; border-color: var(--cor-sucesso); }
        .month-btn span { display: block; font-size: 0.8em; color: var(--cor-texto-secundario); font-weight: 500; }
        .month-btn.active span { color: rgba(255, 255, 255, 0.8); }
        .form-inline { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { display: flex; flex-direction: column; flex-grow: 1; }
        .input-group label { margin-bottom: 5px; font-size: 13px; font-weight: 500; color: var(--cor-texto-secundario); }
        .form-inline input, .form-inline select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--cor-borda); font-size: 14px; }
        .btn, .btn-action { padding: 10px 18px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; }
        .btn { background-color: var(--cor-sucesso); } .btn:hover { background-color: #006442; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--cor-borda); }
        th { font-size: 12px; text-transform: uppercase; color: var(--cor-texto-secundario); }
        .btn-delete { background-color: var(--cor-perigo); padding: 10px 18px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; } .btn-delete:hover { background-color: #bf2600; }
        .btn-reset { background-color: var(--cor-aviso); } .btn-reset:hover { background-color: #ff8f00; }
        .overdue-indicator { color: var(--cor-perigo); font-weight: 700; margin-right: 5px; }
        .conta-paga { background-color: var(--cor-sucesso-fundo) !important; } .conta-paga td { text-decoration: line-through; }
    </style>
</head>
<body>

    <div id="auth-view">
        <div class="auth-form-container">
            <h2>Controle Financeiro</h2>
            <div class="input-group"><label for="auth-email">E-mail</label><input type="email" id="auth-email" placeholder="seu@email.com"></div>
            <div class="input-group"><label for="auth-password">Senha</label><input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div class="auth-actions">
                <button id="btn-login" class="btn">Entrar</button>
                <button id="btn-register" class="btn" style="background-color: var(--cor-texto-secundario);">Criar Conta</button>
            </div>
            <p id="auth-error-message"></p>
        </div>
    </div>

    <div id="app-view" style="display: none;">
        <div class="app-header">
            <div class="header-actions-left">
                <button id="btn-clear" class="btn-delete btn-action">Zerar üóëÔ∏è</button>
                <button id="btn-reset" class="btn-reset btn-action">Resetar üîÑ</button>
            </div>
            <h1>Controle de Contas Mensal</h1>
            <div class="header-actions-right">
                <span class="user-info" id="user-email-display"></span>
                <button id="btn-logout" class="btn-delete btn-action">Sair</button>
            </div>
        </div>
        <main class="dashboard">
            <section class="panel" id="header-main"><h3 >TOTAL DO M√äS</h3><div class="total-mes-item"><span>Contas a Pagar</span><div id="total-a-pagar">R$ 0,00</div></div><div class="total-mes-item"><span>Total de Contas Pagas</span><div id="total-pago">R$ 0,00</div></div><hr style="border: none; border-top: 1px solid var(--cor-borda); margin: 10px 0; width: 100%;"><div class="total-mes-item"><span>Total de Contas</span><div id="total-geral">R$ 0,00</div></div></section>
            <section class="panel" id="header-side"><div id="calendar-container"></div></section>
            <section class="panel" id="form-conta"><h3>Adicionar Nova Conta</h3><form id="form-conta-el" class="form-inline"><div class="input-group"><label for="tipo-conta">Tipo de Conta</label><select id="tipo-conta" required><option value="">Selecione...</option><option value="Moradia">Moradia</option><option value="Alimenta√ß√£o">Alimenta√ß√£o</option><option value="Transporte">Transporte</option><option value="Sa√∫de">Sa√∫de</option><option value="Educa√ß√£o">Educa√ß√£o</option><option value="Lazer">Lazer</option><option value="Contas Fixas">Contas Fixas</option><option value="Outros">Outros</option></select></div><div class="input-group"><label for="nome-conta">Nome da Conta</label><input type="text" id="nome-conta" required></div><div class="input-group"><label for="valor-conta">Valor (R$)</label><input type="number" step="0.01" id="valor-conta" required></div><div class="input-group"><label for="vencimento-conta">Primeiro Vencimento</label><input type="date" id="vencimento-conta" required></div><div class="input-group"><label for="frequencia-conta">Frequ√™ncia</label><select id="frequencia-conta"><option value="unica" selected>√önica</option><option value="semanal">Semanal</option><option value="mensal">Mensal</option></select></div><div class="input-group" id="container-repeticoes" style="display: none;"><label for="numero-repeticoes">N¬∫ de repeti√ß√µes</label><input type="number" id="numero-repeticoes" value="1" min="1"></div><button type="submit" class="btn">Adicionar Conta(s)</button></form></section>
            <section class="panel" id="contas-main"><h3>Minhas Contas do M√™s</h3><table><thead><tr><th>Vencimento</th><th>Categoria</th><th>Descri√ß√£o</th><th>Valor</th><th>Pago</th><th>A√ß√£o</th></tr></thead><tbody id="contas-corpo"></tbody></table></section>
            <aside id="resumo-side"><div class="panel"><h3>Resumo por Categoria</h3><div id="resumo-categoria-body"></div></div><div class="panel"><h3>Total por M√™s</h3><div class="month-grid" id="month-navigation"></div></div></aside>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyC0I_NgRXyRGSqiwu_x3sZizxk710q9kbI",
            authDomain: "controle-financeiro-cuba.firebaseapp.com",
            projectId: "controle-financeiro-cuba",
            storageBucket: "controle-financeiro-cuba.appspot.com",
            messagingSenderId: "276443249627",
            appId: "1:276443249627:web:6b5ad0ccd4ad2faf8885fe"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ESTADO DA APLICA√á√ÉO ---
        let contas = [];
        let displayDate = new Date();
        let unsubscribe = null;
        
        // --- SELETORES DO DOM ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const authEmailEl = document.getElementById('auth-email');
        const authPasswordEl = document.getElementById('auth-password');
        const authErrorMessage = document.getElementById('auth-error-message');
        const btnLogin = document.getElementById('btn-login');
        const btnRegister = document.getElementById('btn-register');
        const btnLogout = document.getElementById('btn-logout');
        const userEmailDisplay = document.getElementById('user-email-display');
        const btnReset = document.getElementById('btn-reset');
        const btnClear = document.getElementById('btn-clear');
        const formConta = document.getElementById('form-conta-el');
        const contasCorpoEl = document.getElementById('contas-corpo');
        const resumoCategoriaBody = document.getElementById('resumo-categoria-body');
        const calendarContainer = document.getElementById('calendar-container');
        const totalAPagarEl = document.getElementById('total-a-pagar');
        const totalPagoEl = document.getElementById('total-pago');
        const totalGeralEl = document.getElementById('total-geral');
        const frequenciaSelect = document.getElementById('frequencia-conta');
        const containerRepeticoes = document.getElementById('container-repeticoes');
        const monthNavigation = document.getElementById('month-navigation');
        const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const mockContas = [ { id: "mock1", tipo: 'Contas Fixas', nome: 'Internet VIVO', valor: 99.90, vencimento: new Date(2025, 6, 15), pago: true }, { id: "mock2", tipo: 'Sa√∫de', nome: 'Plano de Sa√∫de', valor: 350.00, vencimento: new Date(2025, 6, 10), pago: false }, { id: "mock3", tipo: 'Moradia', nome: 'Aluguel', valor: 1850.50, vencimento: new Date(2025, 7, 5), pago: true }, { id: "mock4", tipo: 'Contas Fixas', nome: 'Conta de Luz - Enel', valor: 175.80, vencimento: new Date(2025, 7, 20), pago: false }];

        // --- L√ìGICA DE AUTENTICA√á√ÉO E DADOS ---
        auth.onAuthStateChanged(user => {
            if (user) {
                authView.style.display = 'none';
                appView.style.display = 'block';
                userEmailDisplay.textContent = user.email;
                setupRealtimeListener(user.uid);
            } else {
                authView.style.display = 'block';
                appView.style.display = 'none';
                if (unsubscribe) unsubscribe();
                contas = [];
                renderAll();
            }
        });

        function setupRealtimeListener(userId) {
            if (unsubscribe) unsubscribe();
            const query = db.collection('contas').where('ownerId', '==', userId);
            unsubscribe = query.onSnapshot(snapshot => {
                contas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });
        }
        
        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function getAccountsForDisplay() {
            const displayYear = displayDate.getFullYear(); const displayMonth = displayDate.getMonth();
            const overdueAccounts = contas.filter(conta => { const contaDate = new Date(conta.vencimento.seconds ? conta.vencimento.toDate() : conta.vencimento); return !conta.pago && (contaDate.getFullYear() < displayYear || (contaDate.getFullYear() === displayYear && contaDate.getMonth() < displayMonth)); }).map(conta => ({ ...conta, atrasada: true }));
            const currentMonthAccounts = contas.filter(conta => { const contaDate = new Date(conta.vencimento.seconds ? conta.vencimento.toDate() : conta.vencimento); return contaDate.getFullYear() === displayYear && contaDate.getMonth() === displayMonth; });
            return [...overdueAccounts, ...currentMonthAccounts].sort((a, b) => new Date(a.vencimento.seconds ? a.vencimento.toDate() : a.vencimento) - new Date(b.vencimento.seconds ? b.vencimento.toDate() : b.vencimento));
        }
        function renderAll() {
            renderCalendar(); const accountsToRender = getAccountsForDisplay(); renderTotalMes(accountsToRender); renderResumoCategoria(accountsToRender); renderContas(accountsToRender); renderMonthNavigation();
        }
        function renderCalendar() {
            const year = displayDate.getFullYear(); const month = displayDate.getMonth(); const today = new Date();
            const isCurrentMonthReal = today.getFullYear() === year && today.getMonth() === month;
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            let tableHtml = `<div class="calendar"><div class="calendar-header">${meses[month]} / ${year}</div><table class="calendar-table"><thead><tr><th>D</th><th>S</th><th>T</th><th>Q</th><th>Q</th><th>S</th><th>S</th></tr></thead><tbody>`;
            let date = 1;
            for (let i = 0; i < 6; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDayOfMonth) { tableHtml += '<td></td>'; } else if (date > daysInMonth) { break;
                    } else { let className = (isCurrentMonthReal && date === today.getDate()) ? 'today' : ''; tableHtml += `<td><div class="day-cell ${className}">${date}</div></td>`; date++; }
                }
                tableHtml += '</tr>'; if (date > daysInMonth) break;
            }
            tableHtml += '</tbody></table></div>'; calendarContainer.innerHTML = tableHtml;
        }
        function renderTotalMes(accounts) {
            const aPagar = accounts.filter(c => !c.pago).reduce((sum, c) => sum + c.valor, 0); const pago = accounts.filter(c => c.pago).reduce((sum, c) => sum + c.valor, 0);
            totalAPagarEl.textContent = `R$ ${aPagar.toFixed(2)}`; totalPagoEl.textContent = `R$ ${pago.toFixed(2)}`; totalGeralEl.textContent = `R$ ${(aPagar + pago).toFixed(2)}`;
        }
        function renderResumoCategoria(accounts) {
            resumoCategoriaBody.innerHTML = ''; const resumo = accounts.reduce((acc, conta) => { if (!acc[conta.tipo]) acc[conta.tipo] = 0; acc[conta.tipo] += conta.valor; return acc; }, {});
            if (Object.keys(resumo).length === 0) { resumoCategoriaBody.innerHTML = 'Nenhuma conta neste m√™s.'; return; }
            for (const tipo in resumo) { const item = document.createElement('div'); item.className = 'resumo-categoria-item'; item.innerHTML = `<span>${tipo}</span><strong>R$ ${resumo[tipo].toFixed(2)}</strong>`; resumoCategoriaBody.appendChild(item); }
        }
        function renderContas(accounts) {
            contasCorpoEl.innerHTML = ''; if (accounts.length === 0) { contasCorpoEl.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhuma conta para exibir neste m√™s.</td></tr>'; return; }
            accounts.forEach(conta => {
                const tr = document.createElement('tr'); if (conta.pago) tr.classList.add('conta-paga');
                const dataObj = new Date(conta.vencimento.seconds ? conta.vencimento.toDate() : conta.vencimento);
                const dataFormatada = dataObj.toLocaleDateString('pt-BR');
                tr.innerHTML = `<td>${dataFormatada}</td><td>${conta.tipo}</td><td>${conta.atrasada ? '<span class="overdue-indicator">‚ùó</span>' : ''}${conta.nome}</td><td>R$ ${conta.valor.toFixed(2)}</td><td><input type="checkbox" data-id="${conta.id}" ${conta.pago ? 'checked' : ''}></td><td><button class="btn-delete" data-id="${conta.id}">Excluir</button></td>`;
                contasCorpoEl.appendChild(tr);
            });
        }
        function renderMonthNavigation() {
            monthNavigation.innerHTML = ''; const currentYear = displayDate.getFullYear();
            for (let i = 0; i < 12; i++) {
                const btn = document.createElement('button'); btn.className = 'month-btn'; if (i === displayDate.getMonth()) btn.classList.add('active');
                btn.dataset.month = i;
                const totalMes = contas.filter(c => { const contaDate = new Date(c.vencimento.seconds ? c.vencimento.toDate() : c.vencimento); return contaDate.getMonth() === i && contaDate.getFullYear() === currentYear; }).reduce((sum, c) => sum + c.valor, 0);
                btn.innerHTML = `${meses[i]} / ${currentYear}<span>R$ ${totalMes.toFixed(2)}</span>`; monthNavigation.appendChild(btn);
            }
        }
        function toggleRepeticoes() { containerRepeticoes.style.display = (frequenciaSelect.value === 'unica') ? 'none' : 'flex'; }

        // --- MANIPULADORES DE EVENTOS ---
        btnLogin.addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(err => {authErrorMessage.textContent = err.message}));
        btnRegister.addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(err => {authErrorMessage.textContent = err.message}));
        btnLogout.addEventListener('click', () => auth.signOut());
        
        formConta.addEventListener('submit', event => {
            event.preventDefault();
            const user = auth.currentUser; if (!user) return alert('Voc√™ precisa estar logado para adicionar uma conta.');
            let tipo = document.getElementById('tipo-conta').value; const nome = document.getElementById('nome-conta').value.trim();
            if (tipo === 'Outros') tipo = nome;
            const valor = parseFloat(document.getElementById('valor-conta').value); const vencimentoInicialStr = document.getElementById('vencimento-conta').value;
            const frequencia = frequenciaSelect.value; let repetirVezes = (frequencia === 'unica') ? 1 : parseInt(document.getElementById('numero-repeticoes').value) || 1;
            const [ano, mes, dia] = vencimentoInicialStr.split('-').map(Number); const dataInicial = new Date(ano, mes - 1, dia);
            for (let i = 0; i < repetirVezes; i++) {
                let vencimentoAtual; if (frequencia === 'semanal') { vencimentoAtual = new Date(dataInicial); vencimentoAtual.setDate(dataInicial.getDate() + (i * 7)); } else { vencimentoAtual = new Date(dataInicial.getFullYear(), dataInicial.getMonth() + i, dataInicial.getDate()); }
                const novaConta = { ownerId: user.uid, tipo, nome: repetirVezes > 1 ? `${nome} (${i + 1}/${repetirVezes})` : nome, valor, vencimento: vencimentoAtual, pago: false };
                db.collection('contas').add(novaConta);
            }
            formConta.reset(); toggleRepeticoes();
        });

        contasCorpoEl.addEventListener('click', event => {
            const id = event.target.dataset.id; if (!id) return;
            const contaRef = db.collection('contas').doc(id);
            if (event.target.tagName === 'INPUT') { contaRef.update({ pago: event.target.checked });
            } else if (event.target.tagName === 'BUTTON') { if (confirm('Tem certeza?')) { contaRef.delete(); } }
        });

        monthNavigation.addEventListener('click', event => {
            const target = event.target.closest('.month-btn'); if (target && target.dataset.month) { displayDate.setMonth(parseInt(target.dataset.month)); renderAll(); }
        });
        frequenciaSelect.addEventListener('change', toggleRepeticoes);
        
        btnClear.addEventListener('click', () => {
             if (confirm('Voc√™ tem certeza que deseja apagar TODAS as suas contas? Esta a√ß√£o n√£o pode ser desfeita.')) {
                const user = auth.currentUser; if (!user) return;
                db.collection('contas').where('ownerId', '==', user.uid).get().then(snapshot => {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                }).then(() => alert('Todas as suas contas foram zeradas.'));
            }
        });

        btnReset.addEventListener('click', () => {
            if (confirm('Deseja restaurar os dados de exemplo? TODAS as suas contas atuais ser√£o perdidas.')) {
                const user = auth.currentUser; if (!user) return;
                db.collection('contas').where('ownerId', '==', user.uid).get().then(snapshot => {
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    mockContas.forEach(conta => {
                        const newConta = { ...conta, ownerId: user.uid };
                        delete newConta.id;
                        batch.set(db.collection('contas').doc(), newConta);
                    });
                    return batch.commit();
                }).then(() => alert('Dados de exemplo restaurados!'));
            }
        });

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            displayDate = new Date(today.getFullYear(), today.getMonth(), 1);
        });
    </script>
</body>
</html>

